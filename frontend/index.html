<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - JobTickets Lite</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="/" class="logo">JobTickets Lite</a>
                <nav class="nav">
                    <a href="/">Dashboard</a>
                    <a href="/tickets.html">All Tickets</a>
                    <a href="/create-ticket.html">Create Ticket</a>
                </nav>
                <div class="user-info">
                    <span class="user-name" id="userName">Loading...</span>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <div id="alerts"></div>
            
            <h1 class="page-title">Dashboard</h1>
            <p class="page-subtitle">Overview of your tickets and recent activity</p>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-value" id="totalTickets">-</div>
                    <div class="stat-label">Total Tickets</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="openTickets">-</div>
                    <div class="stat-label">Open Tickets</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="inProgressTickets">-</div>
                    <div class="stat-label">In Progress</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="resolvedTickets">-</div>
                    <div class="stat-label">Resolved</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Recent Tickets</h2>
                    <a href="/create-ticket.html" class="btn btn-primary">Create New Ticket</a>
                </div>
                <div class="table-container">
                    <table class="table" id="recentTicketsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentTicketsBody">
                            <tr>
                                <td colspan="6" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Quick Actions</h2>
                </div>
                <div class="flex gap-2">
                    <a href="/create-ticket.html" class="btn btn-primary">Create New Ticket</a>
                    <a href="/tickets.html" class="btn btn-secondary">View All Tickets</a>
                </div>
            </div>
        </div>
    </main>

    <script src="/js/common.js"></script>
    <script>
        ready(async () => {
            // Check authentication
            const user = await checkAuth();
            if (!user) return;

            document.getElementById('userName').textContent = user.username;

            // Load dashboard data
            await loadDashboardData();
        });

        async function loadDashboardData() {
            try {
                const tickets = await API.getTickets();
                
                // Update statistics
                updateStatistics(tickets);
                
                // Show recent tickets (last 10)
                const recentTickets = tickets.slice(0, 10);
                displayRecentTickets(recentTickets);
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                Utils.showAlert('Failed to load dashboard data', 'error');
            }
        }

        function updateStatistics(tickets) {
            const stats = {
                total: tickets.length,
                open: tickets.filter(t => t.status === 'open').length,
                inProgress: tickets.filter(t => t.status === 'in_progress').length,
                resolved: tickets.filter(t => t.status === 'resolved').length
            };

            document.getElementById('totalTickets').textContent = stats.total;
            document.getElementById('openTickets').textContent = stats.open;
            document.getElementById('inProgressTickets').textContent = stats.inProgress;
            document.getElementById('resolvedTickets').textContent = stats.resolved;
        }

        function displayRecentTickets(tickets) {
            const tbody = document.getElementById('recentTicketsBody');
            
            if (tickets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No tickets found</td></tr>';
                return;
            }

            tbody.innerHTML = tickets.map(ticket => `
                <tr>
                    <td>#${ticket.id}</td>
                    <td>
                        <a href="/ticket-detail.html?id=${ticket.id}" style="text-decoration: none; color: #3498db;">
                            ${ticket.title}
                        </a>
                    </td>
                    <td>
                        <span class="priority-badge priority-${ticket.priority}">
                            ${Utils.capitalize(ticket.priority)}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge status-${ticket.status}">
                            ${Utils.capitalize(ticket.status.replace('_', ' '))}
                        </span>
                    </td>
                    <td>${Utils.formatDate(ticket.created_at)}</td>
                    <td>
                        <div class="table-actions">
                            <a href="/ticket-detail.html?id=${ticket.id}" class="btn btn-small btn-primary">View</a>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>
