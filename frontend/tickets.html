<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Tickets - JobTickets Lite</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="/" class="logo">JobTickets Lite</a>
                <nav class="nav">
                    <a href="/">Dashboard</a>
                    <a href="/tickets.html">All Tickets</a>
                    <a href="/create-ticket.html">Create Ticket</a>
                </nav>
                <div class="user-info">
                    <span class="user-name" id="userName">Loading...</span>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <div id="alerts"></div>
            
            <h1 class="page-title">All Tickets</h1>
            <p class="page-subtitle">View and manage all your tickets</p>

            <!-- Filters -->
            <div class="filters">
                <form id="filtersForm">
                    <div class="filters-row">
                        <div class="form-group search-input">
                            <label for="search" class="form-label">Search</label>
                            <input type="text" id="search" name="search" class="form-input" placeholder="Search tickets...">
                        </div>
                        <div class="form-group">
                            <label for="status" class="form-label">Status</label>
                            <select id="status" name="status" class="form-select">
                                <option value="">All Statuses</option>
                                <option value="open">Open</option>
                                <option value="in_progress">In Progress</option>
                                <option value="resolved">Resolved</option>
                                <option value="closed">Closed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="priority" class="form-label">Priority</label>
                            <select id="priority" name="priority" class="form-select">
                                <option value="">All Priorities</option>
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="assigned_to" class="form-label">Assigned To</label>
                            <select id="assigned_to" name="assigned_to" class="form-select">
                                <option value="">All Users</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="opacity: 0;">Actions</label>
                            <div class="flex gap-1">
                                <button type="button" id="clearFilters" class="btn btn-secondary btn-small">Clear</button>
                                <a href="/create-ticket.html" class="btn btn-primary btn-small">New Ticket</a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Tickets Table -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Tickets</h2>
                    <span id="ticketCount" class="text-right">Loading...</span>
                </div>
                <div class="table-container">
                    <table class="table" id="ticketsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Assigned To</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ticketsBody">
                            <tr>
                                <td colspan="7" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script src="/js/common.js"></script>
    <script>
        let currentTickets = [];
        let users = [];

        ready(async () => {
            // Check authentication
            const user = await checkAuth();
            if (!user) return;

            document.getElementById('userName').textContent = user.username;

            // Load initial data
            await loadUsers();
            await loadTickets();

            // Set up event listeners
            setupEventListeners();
        });

        async function loadUsers() {
            try {
                users = await API.getUsers();
                const assignedToSelect = document.getElementById('assigned_to');
                
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.username;
                    assignedToSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        async function loadTickets() {
            try {
                const filters = getFilters();
                currentTickets = await API.getTickets(filters);
                displayTickets(currentTickets);
                updateTicketCount(currentTickets.length);
            } catch (error) {
                console.error('Error loading tickets:', error);
                Utils.showAlert('Failed to load tickets', 'error');
            }
        }

        function getFilters() {
            const form = document.getElementById('filtersForm');
            const formData = new FormData(form);
            const filters = {};
            
            for (const [key, value] of formData.entries()) {
                if (value.trim() !== '') {
                    filters[key] = value;
                }
            }
            
            return filters;
        }

        function displayTickets(tickets) {
            const tbody = document.getElementById('ticketsBody');
            
            if (tickets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No tickets found</td></tr>';
                return;
            }

            tbody.innerHTML = tickets.map(ticket => `
                <tr>
                    <td>#${ticket.id}</td>
                    <td>
                        <a href="/ticket-detail.html?id=${ticket.id}" style="text-decoration: none; color: #3498db;">
                            ${ticket.title}
                        </a>
                    </td>
                    <td>
                        <span class="priority-badge priority-${ticket.priority}">
                            ${Utils.capitalize(ticket.priority)}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge status-${ticket.status}">
                            ${Utils.capitalize(ticket.status.replace('_', ' '))}
                        </span>
                    </td>
                    <td>${ticket.assigned_to_username || 'Unassigned'}</td>
                    <td>${Utils.formatDate(ticket.created_at)}</td>
                    <td>
                        <div class="table-actions">
                            <a href="/ticket-detail.html?id=${ticket.id}" class="btn btn-small btn-primary">View</a>
                            <button onclick="deleteTicket(${ticket.id})" class="btn btn-small btn-danger">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updateTicketCount(count) {
            document.getElementById('ticketCount').textContent = `${count} ticket${count !== 1 ? 's' : ''}`;
        }

        function setupEventListeners() {
            // Search input with debounce
            const searchInput = document.getElementById('search');
            searchInput.addEventListener('input', Utils.debounce(loadTickets, 300));

            // Filter selects
            const filterSelects = document.querySelectorAll('#filtersForm select');
            filterSelects.forEach(select => {
                select.addEventListener('change', loadTickets);
            });

            // Clear filters button
            document.getElementById('clearFilters').addEventListener('click', () => {
                document.getElementById('filtersForm').reset();
                loadTickets();
            });
        }

        async function deleteTicket(ticketId) {
            if (!confirm('Are you sure you want to delete this ticket?')) {
                return;
            }

            try {
                await API.deleteTicket(ticketId);
                Utils.showAlert('Ticket deleted successfully', 'success');
                await loadTickets();
            } catch (error) {
                console.error('Error deleting ticket:', error);
                Utils.showAlert('Failed to delete ticket', 'error');
            }
        }
    </script>
</body>
</html>
